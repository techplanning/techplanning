<!DOCTYPE html>
<html>

<head>
    <title>로정처_v2</title>
    <meta charset='utf-8' />
</head>

<body>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <!-- override bootstrap style -->
    <style>
    body {
        min-height: 75rem;
        padding-top: 4.5rem;
    }

    .authorizeButtonBox {
        max-width: 500px;
        padding-top: 30px;
        padding-bottom: 30px;
        margin: 0 auto;
    }

    .actionButtonBox {
        max-width: 300px;
        padding: 15px;
        margin: 0 auto;
    }

    .titleStyle {
        color: orange;
    }

    .centeredStyle {
        display: table;
        margin-left: auto;
        margin-right: auto;
    }

    .btn {
        margin-bottom: 10px;
    }
    </style>
    <nav class="navbar navbar-expand-md navbar-light fixed-top bg-light">
        <div class="navbar-brand">로정처_v2</div>
        <ul class="nav nav-pills mr-auto" role="tablist" id="myTab">
            <li class="nav-item">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-expanded="true">홈</a>
            </li>
            <li class="nav-item" id="nav-button1" style="display: none;">
                <a class="nav-link" id="defListCheck-tab" data-toggle="tab" href="#defListCheck" role="tab" aria-controls="defListCheck">정의서 검사</a>
            </li>
            <li class="nav-item" id="nav-button2" style="display: none;">
                <a class="nav-link" id="resultCheck-tab" data-toggle="tab" href="#resultCheck" role="tab" aria-controls="resultCheck">검사 결과 처리</a>
            </li>
            <li class="nav-item" id="nav-button3" style="display: none;">
                <a class="nav-link" id="test-tab" data-toggle="tab" href="#test" role="tab" aria-controls="test">Test</a>
            </li>
        </ul>
        <span class="navbar-text" id="nav-login-message">로그인 해주세요 &nbsp;&nbsp;</span>
        <form class="form-inline mt-2 mt-md-0">
            <button type="button" id="authorize-button" class="btn btn-success my-2 my-sm-0" style="display: none;">로그인</button>
            <button type="button" id="signout-button" class="btn btn-warning my-2 my-sm-0" style="display: none;">로그아웃</button>
        </form>
    </nav>
    <div class="container">
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="card text-center">
                    <div class="card-header">
                        Featured
                    </div>
                    <div class="card-body">
                        <h4 class="card-title">Special title treatment</h4>
                        <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>
                        <a href="#" class="btn btn-primary">Go somewhere</a>
                    </div>
                    <div class="card-footer text-muted">
                        2 days ago
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="defListCheck" role="tabpanel" aria-labelledby="defListCheck-tab">
                <button type="button" class="btn btn-primary btn-block" id="definitionListCheck-button">검사 실행</button>
                <ul class="list-group" id="log"></ul>
                <br>
            </div>
            <div class="tab-pane fade" id="resultCheck" role="tabpanel" aria-labelledby="resultCheck-tab">
            </div>
            <div class="tab-pane fade" id="test" role="tabpanel" aria-labelledby="test-tab">
                <div class="row">
                    <div class="col-2">
                        <div class="list-group" id="list-tab" role="tablist">
                            <a class="list-group-item list-group-item-action active" id="list-home-list" data-toggle="list" href="#list-home" role="tab" aria-controls="home">1</a>
                            <a class="list-group-item list-group-item-action" id="list-profile-list" data-toggle="list" href="#list-profile" role="tab" aria-controls="profile">결과</a>
                            <a class="list-group-item list-group-item-action" id="list-messages-list" data-toggle="list" href="#list-messages" role="tab" aria-controls="messages">셀 업데이트</a>
                            <a class="list-group-item list-group-item-action" id="list-settings-list" data-toggle="list" href="#list-settings" role="tab" aria-controls="settings">4</a>
                        </div>
                    </div>
                    <div class="col-10">
                        <div class="tab-content" id="nav-tabContent">
                            <div class="tab-pane fade show active" id="list-home" role="tabpanel" aria-labelledby="list-home-list">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris sed lacus auctor, euismod metus ac, viverra dolor. Phasellus dictum nec leo vitae sollicitudin. Donec consequat mattis lorem, sit amet egestas enim egestas sed. Ut eros ligula, cursus sit amet aliquet quis, posuere quis nulla. Vestibulum venenatis sagittis pharetra. Pellentesque vel aliquam orci. Ut augue neque, malesuada a vestibulum sed, aliquam vel tellus. Morbi vehicula lacus in iaculis pretium. Phasellus eu aliquet tortor. Morbi accumsan fringilla nisi vitae accumsan. Nunc condimentum nisi quis augue viverra commodo sit amet condimentum purus.</div>
                            <div class="tab-pane fade" id="list-profile" role="tabpanel" aria-labelledby="list-profile-list">
                                <button type="button" class="btn btn-primary btn-block" id="callResults-button">결과 불러오기</button>
                                <button type="button" class="btn btn-secondary btn-block" id="clearResults-button">결과 지우기 (Test)</button>
                                <!--<pre id="results"></pre>-->
                                <ul class="list-group" id="results"></ul>
                                <br>
                            </div>
                            <div class="tab-pane fade" id="list-messages" role="tabpanel" aria-labelledby="list-messages-list">
                                <form>
                                    <div class="form-row align-items-center">
                                        <div class="col-auto">
                                            <label class="sr-only" for="inlineFormInputGroup">Username</label>
                                            <div class="input-group mb-2 mb-sm-0">
                                                <div class="input-group-addon">Prefix</div>
                                                <input type="text" class="form-control" id="formData1" placeholder="입력">
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <button type="button" class="btn btn-primary" id="dataUpdate-button">Update</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="tab-pane fade" id="list-settings" role="tabpanel" aria-labelledby="list-settings-list">Maecenas arcu dui, tincidunt et neque a, rutrum vestibulum elit. Sed magna felis, viverra sed interdum eget, feugiat vel arcu. Curabitur sit amet finibus ante, ultricies pretium ex. Pellentesque commodo mattis nunc, nec dapibus sem aliquet nec. Donec laoreet purus ac dolor ullamcorper, ut aliquet sem vehicula. Nulla ac augue ut nulla commodo tincidunt. Nunc dignissim a ex non dignissim. Nam placerat tellus ac placerat fringilla. Sed finibus scelerisque felis in ultricies. Morbi sodales magna elementum rutrum vehicula. Cras purus velit, commodo ac tincidunt nec, dignissim sit amet nisi. Nam dolor metus, porttitor sit amet dolor in, malesuada maximus risus. Maecenas lobortis tincidunt enim in mollis.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- tab-content -->
    </div>
    <!-- container -->
    <script type="text/javascript">
    // Client ID and API key from the Developer Console
    //var API_KEY = '';
    var CLIENT_ID = '696566559550-7rge69rqjpck7nup7dkfa0tt5huqusi0.apps.googleusercontent.com';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest"];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    var SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    var authorizeButton = document.getElementById('authorize-button');
    var signoutButton = document.getElementById('signout-button');
    var navButton1 = document.getElementById('nav-button1');
    var navButton2 = document.getElementById('nav-button2');
    var navButton3 = document.getElementById('nav-button3');
    var navLoginMessage = document.getElementById('nav-login-message');
    var defListCheckButton = document.getElementById('definitionListCheck-button');
    var callResultsButton = document.getElementById('callResults-button');
    var clearResultsButton = document.getElementById('clearResults-button');
    var dataUpdateButton = document.getElementById('dataUpdate-button');

    /**
     *  On load, called to load the auth2 library and API client library.
     */
    function handleClientLoad() {
        gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
        gapi.client.init({
            //apiKey: API_KEY,
            clientId: CLIENT_ID,
            scope: SCOPES,
            discoveryDocs: DISCOVERY_DOCS,
        }).then(function() {
            // Listen for sign-in state changes.
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

            // Handle the initial sign-in state.
            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

            //
            authorizeButton.onclick = handleAuthClick;
            signoutButton.onclick = handleSignoutClick;
            defListCheckButton.onclick = handleDefListCheckClick;
            callResultsButton.onclick = handlecallResultsClick;
            clearResultsButton.onclick = handleclearResultsClick;
            dataUpdateButton.onclick = handleDataUpdateClick;
        });
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */
    function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
            authorizeButton.style.display = 'none';
            signoutButton.style.display = 'block';
            navButton1.style.display = 'block';
            navButton2.style.display = 'block';
            navButton3.style.display = 'block';
            navLoginMessage.style.display = 'none';
        } else {
            authorizeButton.style.display = 'block';
            signoutButton.style.display = 'none';
            navButton1.style.display = 'none';
            navButton2.style.display = 'none';
            navButton3.style.display = 'none';
            navLoginMessage.style.display = 'block';
        }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
        location.reload();
    }

    /**************************************************************************
     **************************************************************************/
    function handleDefListCheckClick(event) {
        defListCheckButton.style.display = 'none';
        loadSheetsApi();
    }

    /**************************************************************************
     **************************************************************************/
    function handlecallResultsClick(event) {
        //callResultsButton.style.display = 'none';
        loadSheetsApi2();
    }

    /**************************************************************************
     **************************************************************************/
    function handleclearResultsClick(event) {
        appendClear("results");
    }

    /**************************************************************************
     **************************************************************************/
    function handleDataUpdateClick(event) {
        var discoveryUrl =
            'https://sheets.googleapis.com/$discovery/rest?version=v4';
        gapi.client.load(discoveryUrl).then(updateDataTest);
    }

    /**************************************************************************
     **************************************************************************/
    function appendMsgList(message) {
        var node = document.createElement("li");
        node.className = "list-group-item";
        var textContent = document.createTextNode(message + '\n');
        node.appendChild(textContent);
        document.getElementById("log").appendChild(node);
    }

    function appendResults(message) {
        var pre = document.getElementById('results');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
    }

    /**************************************************************************
     **************************************************************************/
    function appendClear(target) {
        document.querySelector("#" + target).innerHTML = "";
    }

    /**************************************************************************
        Load Sheets API client library.
     **************************************************************************/
    function loadSheetsApi() {
        /*
        var discoveryUrl =
            'https://sheets.googleapis.com/$discovery/rest?version=v4';
        gapi.client.load(discoveryUrl).then(readDefinitionList);
        */
        readDefinitionList();
    }

    function loadSheetsApi2() {
        /*
        var discoveryUrl =
            'https://sheets.googleapis.com/$discovery/rest?version=v4';
        gapi.client.load(discoveryUrl).then(callResults);
        */
        callResults();
    }

    /**************************************************************************
        https://stackoverflow.com/questions/12409299/how-to-get-current-formatted-date-dd-mm-yyyy-in-javascript-and-append-it-to-an-i
        
        get today's date.. returning date string in yyyymmdd form,
     **************************************************************************/
    function getTodayDate() {
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth() + 1; //January is 0!

        var yyyy = today.getFullYear();
        if (dd < 10) {
            dd = '0' + dd;
        }
        if (mm < 10) {
            mm = '0' + mm;
        }
        today = yyyy + mm + dd;
        return today;
    }

    /**************************************************************************
        GLOBAL VARIABLES
     **************************************************************************/
    var dumpingSpreadSheetID = '1WKtSplTA8OMBP3aqcsnUJYQB6YNs0T1JoauW3RntkBw';
    var dumpingSheetName = getTodayDate();

    /**************************************************************************
     **************************************************************************/
    function updateDataTest() {
        var testName = document.getElementById('formData1').value;
        gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: dumpingSpreadSheetID,
            range: dumpingSheetName + '!M1',
            valueInputOption: 'USER_ENTERED',
            values: [
                [testName]
            ]
        }).then(function(response) {
            console.log(response);
        });
    }

    /* testing draft ...
    document.getElementById("+buttonUid+").onclick = handleDataUpdateClick;

    function handleDataUpdateClick(event) {
        var tempFormData = document.getElementById(formUid).value;
        var loc = parseInt(tempObj1[tempKeys1[1]]) + 2;
        gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: dumpingSpreadSheetID,
            range: dumpingSheetName + '!N' + String(loc),
            valueInputOption: 'USER_ENTERED',
            values: [
                [tempFormData]
            ]
        }).then(function(response) {
            console.log(response);
        });
    }
    */

    /**************************************************************************
        https://developers.google.com/sheets/api/samples/sheet
     **************************************************************************/
    function addSheet(targetSpreadSheetID, sheetName) {
        var r = (Math.floor(Math.random() * 10) * 0.1);
        var g = (Math.floor(Math.random() * 10) * 0.1);
        var b = (Math.floor(Math.random() * 10) * 0.1);
        gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: targetSpreadSheetID,
            requests: [{
                "addSheet": {
                    "properties": {
                        "title": sheetName,
                        "tabColor": {
                            "red": r,
                            "green": g,
                            "blue": b
                        }
                    }
                }
            }],
        }).then(function(response) {
            console.log(response);
        });
    }

    /**************************************************************************
     **************************************************************************/
    // create temp array storage for mass dumping log data to google sheets.
    var logArray = [];

    function dumpLogData() {
        addSheet(dumpingSpreadSheetID, dumpingSheetName);
        //this function will dump all the log data temporarily stored in logArray to google sheets.
        gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: dumpingSpreadSheetID,
            range: dumpingSheetName + '!A1:E1',
            majorDimension: 'ROWS',
            valueInputOption: 'USER_ENTERED',
            insertDataOption: 'INSERT_ROWS',
            values: logArray,
        }).then(function(response) {
            console.log(response);
            //and clear log array for next dumping...
            logArray.length = 0;
        });

    }

    /**************************************************************************
     **************************************************************************/
    var _PROC = 0,
        _NOTI = 1,
        _SYSTEM = 2;
    var _tagLevelNm = ["[PROCESS]", "[NOTI]", "[SYSTEM]"];
    var _tagLevel = _PROC;

    function msg(tag, message, infoObj, responseObj) {
        if (tag >= _tagLevel) {
            var msg = message;
            msg = _tagLevelNm[tag] + " " + msg;
            if (infoObj) msg = msg + " " + JSON.stringify(infoObj);
            appendMsgList(msg);

            if (tag > _NOTI) console.error(msg, responseObj);

            //dump log into temp array
            var tempArray = [_tagLevelNm[tag], "null", message, JSON.stringify(infoObj)];
            logArray.push(tempArray);
        }
    }

    /**************************************************************************
     **************************************************************************/
    var _ALL = 0,
        _TRACE = 1,
        _DEBUG = 2,
        _INFO = 3,
        _WARN = 4,
        _ERROR = 5,
        _FATAL = 6,
        _OFF = 7;
    var _logLevelNm = ["[ALL]", "[TRACE]", "[DEBUG]", "[INFO]", "[WARN]", "[ERROR]", "[FATAL]", "[OFF]"];
    var _logLevel = _WARN;

    function log(logLevel, code, message, infoObj, targetInfoObj) {
        if (logLevel >= _logLevel) {
            if (logLevel == _ALL) {

            }
            if (logLevel == _TRACE) {

            }
            if (logLevel == _DEBUG) {
                var node = document.createElement("li");
                node.className = "list-group-item list-group-item-dark";
                logMsg = _logLevelNm[logLevel] + " " + code + " - " + message;
                if (infoObj) logMsg = logMsg + "\n\t(처리대상 : " + JSON.stringify(infoObj) + ")";
                if (targetInfoObj) logMsg = logMsg + "\n\t(비교대상 : " + JSON.stringify(targetInfoObj) + ")";
                var textContent = document.createTextNode(logMsg + '\n');
                node.appendChild(textContent);
                document.getElementById("log").appendChild(node);
            }
            if (logLevel == _INFO) {
                var node = document.createElement("li");
                node.className = "list-group-item list-group-item-info";
                logMsg = _logLevelNm[logLevel] + " " + code + " - " + message;
                if (infoObj) logMsg = logMsg + "\n\t(처리대상 : " + JSON.stringify(infoObj) + ")";
                if (targetInfoObj) logMsg = logMsg + "\n\t(비교대상 : " + JSON.stringify(targetInfoObj) + ")";
                var textContent = document.createTextNode(logMsg + '\n');
                node.appendChild(textContent);
                document.getElementById("log").appendChild(node);
            }
            if (logLevel == _WARN) {
                var node = document.createElement("li");
                node.className = "list-group-item list-group-item-warning";
                logMsg = _logLevelNm[logLevel] + " " + code + " - " + message;
                if (infoObj) logMsg = logMsg + "\n\t(처리대상 : " + JSON.stringify(infoObj) + ")";
                if (targetInfoObj) logMsg = logMsg + "\n\t(비교대상 : " + JSON.stringify(targetInfoObj) + ")";
                var textContent = document.createTextNode(logMsg + '\n');
                node.appendChild(textContent);
                document.getElementById("log").appendChild(node);
            }
            if (logLevel == _ERROR) {
                var node = document.createElement("li");
                node.className = "list-group-item list-group-item-danger";
                node.innerHTML = "<span class=\"badge badge-warning\">" + _logLevelNm[logLevel] + " " + code + "</span> " + message;
                /*
                if (infoObj) {
                    var s1 = "<thead><tr>";
                    var s2 = "<tbody><tr>";
                    for (var key in infoObj) {
                        //create html table s
                        s1 += "<th class=\"text-uppercase\">" + key + "</th>";
                        s2 += "<td>" + infoObj[key] + "</td>";
                    }
                    if (targetInfoObj) {
                        s2 += "</tr>";
                        for (var key in targetInfoObj) {
                            s2 += "<td>" + targetInfoObj[key] + "</td>";
                        }
                    }
                    s1 += "</tr></thead>";
                    s2 += "</tr></tbody>";
                    node.insertAdjacentHTML('beforeend', "<br><br><table class=\"table table-sm table-dark table-bordered table-responsive\">" + s1 + s2 + "</table>");
                }
                */
                /* ver.2
                if(infoObj) {
                    node.insertAdjacentHTML('beforeend', "<br><small class=\"text-muted\">" + infoObj["로그정의서명"] + "<br>" + infoObj["spreadsheetId"] + "</small>");
                }
                if(targetInfoObj) {
                    node.insertAdjacentHTML('beforeend', "<br><small class=\"text-muted\">" + "<br>[중복]<br>" + targetInfoObj["로그정의서명"] + "<br>" + infoObj["spreadsheetId"] + "</small>");
                }
                */
                /* ver.1
                if(infoObj) {
                    node.insertAdjacentHTML('beforeend', "<br><small class=\"text-muted\">" + "(처리대상 : " + JSON.stringify(infoObj) + ")"+ "</small>");
                }
                if(targetInfoObj) {
                    node.insertAdjacentHTML('beforeend', "<br><small class=\"text-muted\">" + "(비교대상 : " + JSON.stringify(targetInfoObj) + ")"+ "</small>");
                }*/
                document.getElementById("log").appendChild(node);


                //dump log into temp array
                var tempArray = [_logLevelNm[logLevel], code, message, JSON.stringify(infoObj), JSON.stringify(targetInfoObj)];
                logArray.push(tempArray);
            }
            if (logLevel == _FATAL) {
                var node = document.createElement("li");
                node.className = "list-group-item list-group-item-danger";
                logMsg = _logLevelNm[logLevel] + " " + code + " - " + message;
                if (infoObj) logMsg = logMsg + "\n\t(처리대상 : " + JSON.stringify(infoObj) + ")";
                if (targetInfoObj) logMsg = logMsg + "\n\t(비교대상 : " + JSON.stringify(targetInfoObj) + ")";
                var textContent = document.createTextNode(logMsg + '\n');
                node.appendChild(textContent);
                document.getElementById("log").appendChild(node);
            }
            if (logLevel == _OFF) {

            }
        }
    }

    /**************************************************************************
     **************************************************************************/
    /*
    function callResults() {
        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: dumpingSpreadSheetID,
            range: dumpingSheetName + '!A1:E',
        }).then(function(response) {
            var range = response.result;
            if (range.values.length > 0) {
                for (i = 0; i < range.values.length; i++) {
                    var row = range.values[i];
                    // Print columns A and E, which correspond to indices 0 and 4.
                    appendResults(row[0] + row[2]);
                }
            } else {
                appendResults('No data found.');
            }
        }, function(response) {
            appendResults('Error: ' + response.result.error.message);
        });
    }
    */
    function callResults() {
        var openNode = document.createElement("li");
        openNode.className = "list-group-item list-group-item-info";
        openNode.innerHTML = dumpingSheetName + " 날짜의 검사 결과를 송출합니다.";
        document.getElementById("results").appendChild(openNode);

        gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: dumpingSpreadSheetID,
            range: dumpingSheetName + '!A1:E',
        }).then(function(response) {
            var range = response.result;
            if (range.values.length > 0) {
                for (i = 0; i < range.values.length; i++) {
                    var row = range.values[i];
                    // Print columns A and E, which correspond to indices 0 and 4.
                    //appendResults(row[0] + row[2]);
                    if (row[0] == "[ERROR]") {
                        var node = document.createElement("li");
                        node.className = "list-group-item list-group-item-danger";
                        node.innerHTML = "<span class=\"badge badge-pill badge-warning\">" + row[0] + " 000" + row[1] + "</span><h5>" + row[2] + "</h5>";

                        // 3 로그정의서 링크URL이 잘못 기술되었습니다.
                        if (row[1] == 3) {
                            var tempObj1 = JSON.parse(row[3]);
                            var tempKeys1 = Object.keys(tempObj1);
                            node.insertAdjacentHTML('beforeend', "<br><small class=\"text-muted\">" + tempObj1.spreadsheetTitle + " → " + tempObj1[tempKeys1[0]] + " → " + tempObj1[tempKeys1[1]] + "</small>");
                            //
                            var s1 = "<thead><tr>";
                            var s2 = "<tbody><tr>";
                            s1 += "<th class=\"text-uppercase\">" + tempKeys1[2] + "</th>" + "<th class=\"text-uppercase\">" + tempKeys1[3] + "</th>";
                            s2 += "<td>" + tempObj1[tempKeys1[2]] + "</td>" + "<td>" + tempObj1[tempKeys1[3]] + "</td>";
                            s1 += "</tr></thead>";
                            s2 += "</tr></tbody>";
                            node.insertAdjacentHTML('beforeend', "<br><table class=\"table table-sm table-secondary table-responsive\">" + s1 + s2 + "</table>");
                            //
                            var modalUid = "modal-" + row[1] + tempObj1[tempKeys1[0]] + tempObj1[tempKeys1[1]];
                            var formUid = "form-" + row[1] + tempObj1[tempKeys1[0]] + tempObj1[tempKeys1[1]];
                            var buttonUid = "button-" + row[1] + tempObj1[tempKeys1[0]] + tempObj1[tempKeys1[1]];
                            node.insertAdjacentHTML('beforeend', "<div class=\"text-right\"><button type=\"button\" class=\"btn btn-primary btn-sm\" data-toggle=\"modal\" data-target=\"." + modalUid + "\">수정하기</button></div><div class=\"modal fade " + modalUid + "\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myLargeModalLabel\" aria-hidden=\"true\"><div class=\"modal-dialog modal-lg\"><div class=\"modal-content\"><div class=\"modal-header\"><h5 class=\"modal-title\"><span class=\"badge badge-pill badge-warning\">" + row[0] + " 000" + row[1] + "</span> " + row[2] + "</h5><button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button></div><div class=\"modal-body\"> <small class=\"text-muted\">" + tempObj1.spreadsheetTitle + " → " + tempObj1[tempKeys1[0]] + " → " + tempObj1[tempKeys1[1]] + "</small> <form><div class=\"form-group\"><label>로그정의서명</label><input class=\"form-control\" type=\"text\" placeholder=\"" + tempObj1[tempKeys1[2]] + "\" readonly></div> <div class=\"form-group\"><label>로그정의서 링크URL</label><input class=\"form-control is-invalid\" type=\"text\" id=\"" + formUid + "\" placeholder=\"" + tempObj1[tempKeys1[3]] + "\"><small class=\"invalid-feedback\">올바른 로그정의서 링크URL을 입력 해 주세요.</small></div></form> </div><div class=\"modal-footer\"><button type=\"button\" class=\"btn btn-secondary\" data-dismiss=\"modal\">취소</button><button type=\"button\" class=\"btn btn-primary\" id=\"" + buttonUid + "\">저장</button></div></div></div></div>  <script type='text/javascript'>document.getElementById(" + buttonUid + ").onclick = handleDataUpdateClick; function handleDataUpdateClick(event) {var tempFormData = document.getElementById(" + formUid + ").value; gapi.client.sheets.spreadsheets.values.update({spreadsheetId: dumpingSpreadSheetID, range: dumpingSheetName + '!M1', valueInputOption: 'USER_ENTERED', values: [[tempFormData]]}).then(function(response) {console.log(response);});}</" + "script>");

                        }

                        // 8 같은 정의서 URL을 공유하는 서로 다른 로그정의서명이 있습니다.
                        // 9 동일한 POC에 중복된 정의서 링크가 있습니다.
                        if (row[1] == 8 || row[1] == 9) {
                            var tempObj1 = JSON.parse(row[3]);
                            var tempObj2 = JSON.parse(row[4]);
                            var tempKeys1 = Object.keys(tempObj1);
                            var tempKeys2 = Object.keys(tempObj2);
                            node.insertAdjacentHTML('beforeend', "<br><small class=\"text-muted\">" + tempObj1.spreadsheetTitle + " → " + tempObj1[tempKeys1[0]] + " → " + tempObj1[tempKeys1[1]] + "</small>");
                            //
                            var s1 = "<thead><tr>";
                            var s2 = "<tbody><tr>";
                            s1 += "<th class=\"text-uppercase\">" + tempKeys1[2] + "</th>" + "<th class=\"text-uppercase\">" + tempKeys1[4] + "</th>" + "<th class=\"text-uppercase\">" + tempKeys1[5] + "</th>";
                            s2 += "<td>" + tempObj1[tempKeys1[2]] + "</td>" + "<td>" + tempObj1[tempKeys1[4]] + "</td>" + "<td>" + tempObj1[tempKeys1[5]] + "</td>";
                            s1 += "</tr></thead>";
                            s2 += "</tr></tbody>";
                            node.insertAdjacentHTML('beforeend', "<br><table class=\"table table-sm table-secondary table-responsive\">" + s1 + s2 + "</table>");

                            //
                            node.insertAdjacentHTML('beforeend', "<small class=\"text-muted\">" + tempObj2.spreadsheetTitle + " → " + tempObj2[tempKeys2[0]] + " → " + tempObj2[tempKeys2[1]] + "</small>");

                            //
                            var s1 = "<thead><tr>";
                            var s2 = "<tbody><tr>";
                            s1 += "<th class=\"text-uppercase\">" + tempKeys2[2] + "</th>" + "<th class=\"text-uppercase\">" + tempKeys2[4] + "</th>" + "<th class=\"text-uppercase\">" + tempKeys2[5] + "</th>";
                            s2 += "<td>" + tempObj2[tempKeys2[2]] + "</td>" + "<td>" + tempObj2[tempKeys2[4]] + "</td>" + "<td>" + tempObj2[tempKeys2[5]] + "</td>";
                            s1 += "</tr></thead>";
                            s2 += "</tr></tbody>";
                            node.insertAdjacentHTML('beforeend', "<br><table class=\"table table-sm table-secondary table-responsive\">" + s2 + "</table>");
                            /*
                            node.insertAdjacentHTML('beforeend', "<div class=\"text-right\"><button type=\"button\" class=\"btn btn-primary btn-sm\" data-toggle=\"modal\" data-target=\".bd-example-modal-lg\">수정하기</button></div><div class=\"modal fade bd-example-modal-lg\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"myLargeModalLabel\" aria-hidden=\"true\"><div class=\"modal-dialog modal-lg\"><div class=\"modal-content\"><div class=\"modal-header\"><h5 class=\"modal-title\" id=\"definitionCheckResultModalTitle\">" + row[2] + "</h5><button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button></div><div class=\"modal-body\"><ul class=\"list-group\" id=\"log\"></ul></div><div class=\"modal-footer\"><button type=\"button\" class=\"btn btn-secondary\" id=\"dataDismiss-button\" data-dismiss=\"modal\">취소</button><button type=\"button\" class=\"btn btn-primary\" id=\"dataSave-button\">저장</button></div></div></div></div>");
                            */
                        }

                        document.getElementById("results").appendChild(node);
                    }
                }
            } else {
                //appendResults('No data found.');
            }
        }, function(response) {
            //appendResults('Error: ' + response.result.error.message);
        });
    }

    /**************************************************************************
     **************************************************************************/
    var _defList = [];
    var _sheet = [];
    var _sheetMap = {};

    function readDefinitionList() {
        var spreadsheetId = '1o2mfQ2GOxRcl43oyfH0eBcs35P5kis1wCgbZYjLilx0';
        var spreadsheetTitle = 'PageID_11번가 Log 2.0 Copy';
        var sheetTitle = ['모바일 v.2.3', 'PC v.2.1'];

        msg(_PROC, "스프레드시트 처리 시작", { spreadsheetTitle: [spreadsheetTitle], sheetTitle: [sheetTitle] });

        var params = {
            spreadsheetId: [spreadsheetId],
            ranges: [
                sheetTitle[0] + '!N2:O',
                sheetTitle[1] + '!M2:N'
            ]
        };

        gapi.client.sheets.spreadsheets.values.batchGet(params).then(function(response) {
            var valueRanges = response.result.valueRanges;
            var sheetSize = valueRanges.length;
            var poc = ['MW', 'PC'];
            if (sheetSize == sheetTitle.length) {
                for (s = 0; s < sheetSize; s++) {
                    msg(_PROC, "[" + spreadsheetTitle + "] 문서 [" + sheetTitle[s] + "] 시트에 기록된 ID 추출을 시작합니다.", { spreadsheetTitle: [spreadsheetTitle], sheetTitle: [sheetTitle[s]] }, response);
                    var range = valueRanges[s];
                    if (range.values.length > 0) {
                        var rowSize = range.values.length;

                        var data = [];
                        for (r = 1; r < rowSize; r++) {
                            if (range.values[r]) {
                                data[r - 1] = {};
                                data[r - 1]["poc"] = poc[s];
                                data[r - 1]["no"] = r;
                                var colSize = range.values[r].length;
                                for (c = 0; c < colSize; c++) {
                                    data[r - 1][range.values[0][c]] = range.values[r][c];
                                }
                                if (data[r - 1]["로그정의서 링크URL"]) {
                                    // The spreadsheet ID is a string containing letters, numbers, and some special characters. The following regular expression can be used to extract the spreadsheet ID from a Google Sheets URL: "/spreadsheets\/d\/([a-zA-Z0-9-_]+)" .... Regular expression to extract sheet ID: "/[#&]gid=([0-9]+)"

                                    // 기록된 로그정의서 링크 URL에서 spreadsheetID 추출 후 data array에 보관
                                    var regEx1 = /spreadsheets\/d\/([a-zA-Z0-9-_]+)/.exec(data[r - 1]["로그정의서 링크URL"]);
                                    if (regEx1 && regEx1.length > 0) {
                                        data[r - 1]["spreadsheetId"] = regEx1[1];
                                    }
                                    // 기록된 로그정의서 링크 URL에서 sheetID 추출 후 data array에 보관
                                    var regEx2 = /[#&]gid=([0-9]+)/.exec(data[r - 1]["로그정의서 링크URL"]);
                                    if (regEx2 && regEx2.length > 0) {
                                        data[r - 1]["sheetId"] = regEx2[1];
                                    }
                                }
                            }
                        }
                        // concat method를 이용하여 data array를 글로벌 변수 _defList array에 join
                        _defList = _defList.concat(data);

                        // 완료 메시지 표시
                        msg(_PROC, "ID 추출 처리가 완료되었으며, 이제 검증작업이 가능합니다.", { spreadsheetTitle: [spreadsheetTitle], sheetTitle: [sheetTitle[s]] });
                    } else {
                        msg(_SYSTEM, "시트 처리 오류 - No data found.", { spreadsheetTitle: [spreadsheetTitle], sheetTitle: [sheetTitle[s]] }, response);
                    }
                }
                msg(_PROC, "스프레드시트 처리 완료", { spreadsheetTitle: [spreadsheetTitle], sheetTitle: [sheetTitle] });
                checkDefList(spreadsheetTitle);
                loadSheets();
            } else {
                msg(_SYSTEM, "스프레드시트 처리 오류 - POC별 시트 로딩 실패.", { spreadsheetTitle: [spreadsheetTitle] }, response);
            }
        }, function(response) {
            msg(_SYSTEM, "스프레드시트 처리 오류 - " + response.result.error.message, { spreadsheetTitle: [spreadsheetTitle] }, response);
        });
    }

    /**************************************************************************
     **************************************************************************/
    function loadSheets() {

    }

    /**************************************************************************
     **************************************************************************/
    function checkDefList(spreadsheetTitle) {
        msg(_PROC, "로그 정의서 내역 검증 시작", { spreadsheetTitle: [spreadsheetTitle] });

        var defSize = _defList.length;
        for (d = 0; d < defSize; d++) {
            var info = _defList[d];
            info.spreadsheetTitle = spreadsheetTitle;

            // 빈 값 체크
            if (!info["로그정의서명"]) {
                log(_DEBUG, "0001", "로그정의서명이 없습니다.", info);
            } else if (!/^\[로그정의서\] .*$/.test(info["로그정의서명"])) {
                log(_ERROR, "0005", "로그정의서명 서식이 올바르지 않습니다.", info);
            }

            if (!info["로그정의서 링크URL"]) {
                log(_DEBUG, "0002", "로그정의서 링크URL이 없습니다.", info);
            } else {
                if (!info["spreadsheetId"]) {
                    log(_ERROR, "0003", "로그정의서 링크URL이 잘못 기술되었습니다.", info);
                } else {
                    if (!info["sheetId"]) {
                        log(_ERROR, "0004", "로그정의서 링크URL이 파일에 대한 링크로, 시트에 대한 링크가 아닙니다.", info);
                    }
                }
            }

            // 중복체크
            if (info["spreadsheetId"]) {
                if (_sheetMap[info["spreadsheetId"]]) {
                    var targetInfo = _sheetMap[info["spreadsheetId"]];
                    if (info["poc"] == targetInfo["poc"]) {
                        log(_ERROR, "0009", "동일한 POC에 중복된 정의서 링크가 있습니다.", info, targetInfo);
                    } else {
                        log(_INFO, "0006", "중복된 정의서 링크가 있습니다.", info, targetInfo);
                    }

                    if (targetInfo["로그정의서명"] != info["로그정의서명"]) {
                        log(_ERROR, "0008", "같은 정의서 URL을 공유하는 서로 다른 로그정의서명이 있습니다.", info, targetInfo);
                    }

                    if (info["sheetId"] && targetInfo["sheetId"] == info["sheetId"]) {
                        log(_ERROR, "0007", "중복된 정의서 시트 링크가 있습니다.", info, targetInfo);
                    }
                } else {
                    _sheetMap[info["spreadsheetId"]] = info
                }
            }
        }
        msg(_PROC, "로그 정의서 내역 검증 완료", { spreadsheetTitle: [spreadsheetTitle] });
        dumpLogData();
    }
    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()"></script>
</body>

</html>